---
title: "3_1_desc_stats"
author: "Mei"
date: "2024-09-18"
output: pdf_document
---

## Import data
```{r, include=F}
library(dplyr)
# For Office PC
setwd("C:/Users/kuo.355/OneDrive - The Ohio State University/1_Second_Year_Paper/3_Data_Analysis/Data")
# For Macbook
# setwd("/Users/kuomico/Library/CloudStorage/OneDrive-TheOhioStateUniversity/1_Second_Year_Paper/3_Data_Analysis/Data")

dta_orig_wide <- readRDS("Cleaned_Data/R/wide.rds")
dta_orig_long <- readRDS("Cleaned_Data/R/long.rds")
# dta_orig <- read.csv("Cleaned_Data/R/test.csv")

```

## Demo. composition (Can do this later) (Change to wide-form)
```{r, eval=F, include=F}
# Y: edu, college_major_stem, college_major_app, college_major_stemapp
# X: gender, race, p_edu
list_y <- c("edu_degree")
list_x <- c("gender", "race", "p_edu")

# table freq
# Sample: Wide form. All.
df <- dta %>%
  filter(!duplicated(id))

df <- df[,c("gender","edu_degree")]
for (y in list_y){
  for (x in list_x){
    print(paste(y,x))
 
    # table
    print(table(df[[y]], df[[x]]))
    print(round(prop.table(table(df[[y]], df[[x]]), margin = 1),3))
  }
}

# Sample: BA degree holders
df <- dta %>%
  filter(!duplicated(id))
df <- subset(df, edu_degree >= "BA")
list_y <- c("college_major_stem", "college_major_app")
list_x <- c("gender", "race", "p_edu")

for (y in list_y){
  for (x in list_x){
    print(paste(y,x))
 
    # table
    print(table(df[[y]], df[[x]]))
    print(round(prop.table(table(df[[y]], df[[x]]), margin = 1),3))
  }
}

# Plotting
# Barplot can make more sense since both Ys and Xs are categorical.
# df <- dta
# df$gender <- as.factor(df$gender)
# df$college_major_stem <- as.factor(df$college_major_stem)
# 
# p <- ggplot(data=df %>% drop(""), aes(x=college_major_stem,fill=gender)) +  
#   geom_bar(position="dodge",mapping=aes(y=..prop..,group=gender)) + theme_classic() + 
#   labs(x="College_major",y="Count of Respondents",fill="Gender") +
#   theme(legend.position="bottom")
# show(p)



```

## Y: Edu, X: Demo.
```{r, eval=F, include=F}
# Y: edu, college_major_stem, college_major_app, college_major_stemapp
# X: gender, race, p_edu

# Sample: Wide-form. All.
df <- dta %>%
  filter(!duplicated(id))
df <- df

# table freq
list_y <- c("edu_degree", "college_major_stemapp")
list_x <- c("gender", "race", "p_edu")

for (y in list_y){
  for (x in list_x){
     # table
    print(table(df[[y]], df[[x]]))
    print(round(prop.table(table(df[[y]], df[[x]]), margin = 1),3))
  }
}

# Sample: Wide-form. BA degree holders.
df <- dta %>%
  filter(!duplicated(id))
df <- subset(df, edu_degree >= "BA")

# table freq
list_y <- c("edu_degree", "college_major_stemapp")
list_x <- c("gender", "race", "p_edu")

for (y in list_y){
  for (x in list_x){
     # table
    print(table(df[[y]], df[[x]]))
    print(round(prop.table(table(df[[y]], df[[x]]), margin = 1),3))
  }
}

```

## Y: Wage
save the following individual-aggregate vars in list_sum
```{r wage, eval=F, include=F}
# Initialize a list for saving
list_sum <- list()

# Locate data
df <- dta_orig_long

# 3 measures: First, Last measure, Change 

# Sample: Long-form.1 Obs starts after attaining highest degree.
# Exclude wage == 0
df_sum <- df %>% filter(flag_highest == 1) %>%
  arrange(id, cw) %>%
  group_by(id) %>% 
  summarize(
    wage_1 = first(na.omit(job_wage[job_wage != 0])), 
    cw_1 = cw[which.min(is.na(job_wage) | job_wage == 0)],
    wage_n = last(na.omit(job_wage[job_wage != 0])),
    cw_n = cw[rev(which(!is.na(job_wage) & job_wage != 0))[1]],
    wage_n1 = last(na.omit(job_wage[job_wage != 0])) - first(na.omit(job_wage[job_wage != 0])),
    job_tenure = cw[rev(which(!is.na(job_wage) & job_wage != 0))[1]] - cw[which.min(is.na(job_wage) | job_wage == 0)]
    
  ) %>%
  ungroup()
  
# Merge the IVs back with df_sum
list_var <- c("id", "gender",  "race", "p_edu", "edu_degree", "citizen", 
              "major_apst")
df <- dta_orig_wide %>% 
      select(id, all_of(list_var))

df_sum <- merge(df_sum, df, by = "id",all.y = T)

# Check
summary(df_sum)

# Save data
list_sum[["Y"]] <- df_sum

```

## M: Employment interruptions/discontinuitues
1.	Check construction of interruption vars: unique should be smaller than # changes.
a.	This can be possible. Unique: 1, change:0. Unique: 2, change: 1+. Unique: 3, change: 2+.
b.	Should we subtract unique from 1? How should we consider those never employed (n=?)?

2. For those missing period, I fill those with the last valid values.
```{r, include=F}
# 6 measurements
# 1) # Shift to different employer
# 2) # Shift to different EGP occupation
# 3) # unique employer
# 4) # unique EGP occupation
# 5) # Shift labor force status: Paid work/Out of labor force
# 6) # Shift labor force status: Full-time/Part-time

# Library
library(dplyr)

# Locate data
df <- dta_orig_long 
  
##################
# Sample: Long-form. Obs starts after attaining highest degree. Do not apply for <HS & Missing.   
df_sum <- df %>%
  filter(flag_highest == 1) %>%
  group_by(id) %>%
  arrange(cw) %>%
  # Fill forward the last valid (non-NA) value
  mutate(
    job_id_filled = zoo::na.locf(job_id, na.rm = FALSE),  # Fill NA with the last valid value
    job_8egp_filled = zoo::na.locf(job_8egp, na.rm = FALSE),
    job_full_bi_filled = zoo::na.locf(job_full_bi, na.rm = FALSE),
    job_full_filled = zoo::na.locf(job_full, na.rm = FALSE)
  ) %>%
  # Compare shifts using the filled columns
  mutate(
    employer_shift = job_id_filled != lag(job_id_filled, default = first(job_id_filled)),
    egp_shift = job_8egp_filled != lag(job_8egp_filled, default = first(job_8egp_filled)),
    full_shift = job_full_bi_filled != lag(job_full_bi_filled, default = first(job_full_bi_filled)),
    part_shift = job_full_filled != lag(job_full_filled, default = first(job_full_filled))
  ) %>%
  summarise(
    n_shift_emp = sum(employer_shift, na.rm = TRUE),
    n_shift_egp = sum(egp_shift, na.rm = TRUE),
    n_shift_full = sum(full_shift, na.rm = TRUE),
    n_shift_part = sum(part_shift, na.rm = TRUE),
    n_emp = n_distinct(job_id, na.rm = TRUE),
    n_8egp = n_distinct(job_8egp_cat, na.rm = TRUE)
  )

  
##################
# Merge back with list_sum[["Y"]]

df_sum <- merge(df_sum, list_sum[["Y"]], by = "id",all.y = T)

# Check
summary(df_sum)

# Save data
list_sum[["M"]] <- df_sum
#saveRDS(df_sum, "Cleaned_Data/R/df_sum.rds")

```

## Plotting: Y: 6 measures of career interruptions, X: gender & educational level
```{r plotting, include=T}
library(ggplot2)
# Locate used data
df <- df_sum

# Initialize list_plot
list_plot <- list()

# Sample: All but missing in edu_degree
list_var <- c("n_shift_emp", "n_shift_egp", "n_emp", "n_8egp","n_shift_full", "n_shift_part")
list_var_lab <- c("# Changing employers", "# Changing EGP occupations",
                  "# unique employers", "# unique EGP occupations",
                  "# Changing labor force status: Paid work/Out of labor force",
                  "# Changing labor force status: Full-time/Part-time/Out of labor force")

for (i in 1:length(list_var)) {
  
  var <- list_var[[i]]
  var_lab <- list_var_lab[[i]]
  
  p <- ggplot(filter(df,!is.na(edu_degree_lv) & edu_degree_lv != "Missing"),
              aes(x = edu_degree_lv, y = .data[[var]], fill = edu_degree_lv)) + 
    geom_bar(stat = "summary", fun = "mean") + 
    geom_errorbar(stat = "summary", fun.data = "mean_se", fun.args = list(mult = 1.96)) +
    stat_summary(
      aes(label = round(..y.., 3)), 
      geom = "text", 
      fun = mean, 
      vjust = 1.5, 
      color = "white", 
      size = 3.5
    ) +
    facet_wrap(~gender) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(title = var_lab)  
  
  show(p)
  list_plot[[var]] <- p
  
}
```

```{r}
# Sample: BA and BA+
# Initialize list_plot

for (i in 1:length(list_var)) {
  
  var <- list_var[[i]]
  var_lab <- list_var_lab[[i]]
  
  p <- ggplot(filter(df,major_apst %in% c("Academic non-STEM", "Academic STEM", "Applied non-STEM", "Applied STEM")),
              aes(x = major_apst, y = .data[[var]], fill = major_apst)) + 
    geom_bar(stat = "summary", fun = "mean") + 
    geom_errorbar(stat = "summary", fun.data = "mean_se", fun.args = list(mult = 1.96)) +
    stat_summary(
      aes(label = round(..y.., 3)), 
      geom = "text", 
      fun = mean, 
      vjust = 1.5, 
      color = "white", 
      size = 3.5
    ) +
    facet_wrap(~gender) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(title = var_lab)  
  
  show(p)
  list_plot[["major"]][[var]] <- p
  
}




```


```{r tables, eval=F, include=F}
library(dplyr)
library(rlang)

# Initialize a list_df_sum
list_sum <- list()

# Locate data
df <- df_sum

# Sample: All

  df_sum <- df %>%
    group_by(genderedu) %>%  # Convert the string to a symbol and unquote it
    summarize(
      m_n_shift_emp = mean(n_shift_emp, na.rm = TRUE),
      m_n_shift_egp = mean(n_shift_egp, na.rm = TRUE),
      m_n_shift_full = mean(n_shift_full, na.rm = TRUE),
      m_n_shift_part = mean(n_shift_part, na.rm = TRUE),
      m_n_emp = mean(n_emp, na.rm = TRUE),
      m_n_8egp = mean(n_8egp, na.rm = TRUE),
      N = n()
    )
 
print(df_sum)

# Sample : BA
list_group <- c("major_apst", "gender", "genderrace")
for (i in 1:length(list_group)){
  print(list_group[i])
  
  df_sum <- filter(df,edu_degree %in% c("BA", "BA+")) %>% 
 group_by(!!sym(list_group[i])) %>%  # Convert the string to a symbol and unquote it
    summarize(
      m_n_shift_emp = mean(n_shift_emp, na.rm = TRUE),
      m_n_shift_egp = mean(n_shift_egp, na.rm = TRUE),
      m_n_shift_full = mean(n_shift_full, na.rm = TRUE),
      m_n_shift_part = mean(n_shift_part, na.rm = TRUE),
      m_n_emp = mean(n_emp, na.rm = TRUE),
      m_n_8egp = mean(n_8egp, na.rm = TRUE),
      N = n()
    )
  
  list_sum[[list_group[i]]] <- df_sum
  
}

```

## Export data
```{r}
library(foreign)

# Save wide-form data
df <- df_sum
# write.csv(df, "Cleaned_Data/R/sum_wide.csv", row.names = FALSE)
saveRDS(df, "Cleaned_Data/R/sum_wide.rds")
write.dta(df, "Cleaned_Data/R/sum_wide.dta")

```



